---
title: "Models"
author: "Edward Bosko"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(ggplot2)
library(emmeans)
library(ordinal)
library(nlme)
library(glmmTMB)
library(brms)
library(multgee)
library(lme4)
library(geepack)
```

## Purpose

This file will be used to compare different models for each CT feature

## Reading in Data

### Tree-in-bud

```{r}
# Read in each rater's sheet
vh_tib <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "VH.TIB.Long") %>% 
  mutate(rater = "VH")

jw_tib <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "JW.TIB.Long") %>% 
  mutate(rater = "JW")

tib <- bind_rows(vh_tib, jw_tib)
```

### Large Nodules

```{r}
# Read in each rater's sheet
vh_ln <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "VH.LN.Long") %>% 
  mutate(rater = "VH")

jw_ln <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "JW.LN.Long") %>% 
  mutate(rater = "JW")

ln <- bind_rows(vh_ln, jw_ln)
```

### Ground-glass Opacities

```{r}
# Read in each rater's sheet
vh_ggo <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "VH.GGO.Long") %>% 
  mutate(rater = "VH")

jw_ggo <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "JW.GGO.Long") %>% 
  mutate(rater = "JW")

ggo <- bind_rows(vh_ggo, jw_ggo)
```

### Consolidations

```{r}
# Read in each rater's sheet
vh_cons <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "VH.CONS.Long") %>% 
  mutate(rater = "VH")

jw_cons <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "JW.CONS.Long") %>% 
  mutate(rater = "JW")

cons <- bind_rows(vh_cons, jw_cons)
```

### Bronchiectasis

```{r}
# Read in each rater's sheet
vh_bronch <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "VH.BRONCH.Long") %>% 
  mutate(rater = "VH")

jw_bronch <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "JW.BRONCH.Long") %>% 
  mutate(rater = "JW")

bronch <- bind_rows(vh_bronch, jw_bronch)
```

### Atelectasis

```{r}
# Read in each rater's sheet
vh_atel <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "VH.ATEL.Long") %>% 
  mutate(rater = "VH")

jw_atel <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "JW.ATEL.Long") %>% 
  mutate(rater = "JW")

atel <- bind_rows(vh_atel, jw_atel)
```

### Thin-wall Cavity

```{r}
# Read in each rater's sheet
vh_thin <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "VH.Thin.Long") %>% 
  mutate(rater = "VH")

jw_thin <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "JW.Thin.Long") %>% 
  mutate(rater = "JW")

thin <- bind_rows(vh_thin, jw_thin)
```

### Thick-wall Cavity

```{r}
# Read in each rater's sheet
vh_thick <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "VH.Thick.Long") %>% 
  mutate(rater = "VH")

jw_thick <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.2.4.xlsx', sheet = "JW.Thick.Long") %>% 
  mutate(rater = "JW")

thick <- bind_rows(vh_thick, jw_thick)
```

## Models

### Tree-in-bud

```{r}
#make sure everything is in correct format
tib$Value <- ordered(tib$Value, levels = c(0,1,2,3))
tib$Attribute <- factor(tib$Attribute, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
tib$newID <- factor(tib$newID)
tib$rater <- factor(tib$rater)

#model 1 - lobe and rater as fixed effects and random int
tib_mod1 <- clmm(
  Value ~ Attribute + rater + (1 | newID),
  data = tib
)

summary(tib_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(tib_mod1, ~ Attribute, type = "link")
pairs(emm)
```

### Large Nodules

```{r}
#make sure everything is in correct format
ln$Value <- as.numeric(as.character(ln$Value))
ln_clean <- ln %>% filter(Value %in% c(0, 1))
ln$Attribute <- factor(ln$Attribute, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
ln$newID <- factor(ln$newID)
ln$rater <- factor(ln$rater)

#model 1 - lobe and rater as fixed effects and random int
ln_mod1 <- glmer(Value ~ Attribute + rater + (1 | newID),
                data = ln_clean,
                family = binomial(link = "logit"))
summary(ln_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(ln_mod1, ~ Attribute, type = "link")
pairs(emm)
```

### Ground-glass Opacities

```{r}
#make sure everything is in correct format
ggo$Value <- ordered(ggo$Value, levels = c(0,1,2,3))
ggo$Attribute <- factor(ggo$Attribute, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
ggo$newID <- factor(ggo$newID)
ggo$rater <- factor(ggo$rater)

#model 1 - lobe and rater as fixed effects and random int
ggo_mod1 <- clmm(
  Value ~ Attribute + rater + (1 | newID),
  data = ggo
)

summary(ggo_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(ggo_mod1, ~ Attribute, type = "link")
pairs(emm)
```

### Consolidations

```{r}
#make sure everything is in correct format
cons$Value <- ordered(cons$Value, levels = c(0,1,2,3))
cons$Attribute <- factor(cons$Attribute, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
cons$newID <- factor(cons$newID)
cons$rater <- factor(cons$rater)

#model 1 - lobe and rater as fixed effects and random int
cons_mod1 <- clmm(
  Value ~ Attribute + rater + (1 | newID),
  data = cons
)

summary(cons_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(cons_mod1, ~ Attribute, type = "link")
pairs(emm)
```

### Bronchiectasis

```{r}
#make sure everything is in correct format
bronch$Value <- ordered(bronch$Value, levels = c(0,1,2,3))
bronch$Attribute <- factor(bronch$Attribute, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
bronch$newID <- factor(bronch$newID)
bronch$rater <- factor(bronch$rater)

#model 1 - lobe and rater as fixed effects and random int
bronch_mod1 <- clmm(
  Value ~ Attribute + rater + (1 | newID),
  data = bronch
)

summary(bronch_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(bronch_mod1, ~ Attribute, type = "link")
pairs(emm)
```

### Atelectasis

```{r}
#make sure everything is in correct format
atel$Value <- ordered(atel$Value, levels = c(0,1,2,3))
atel$Attribute <- factor(atel$Attribute, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
atel$newID <- factor(atel$newID)
atel$rater <- factor(atel$rater)

#model 1 - lobe and rater as fixed effects and random int
atel_mod1 <- clmm(
  Value ~ Attribute + rater + (1 | newID),
  data = atel
)

summary(atel_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(atel_mod1, ~ Attribute, type = "link")
pairs(emm)
```

### Thin-wall Cavity

```{r}
#make sure everything is in correct format
thin$Value <- as.numeric(as.character(thin$Value))
thin$Attribute <- factor(thin$Attribute, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
thin$newID <- factor(thin$newID)
thin$rater <- factor(thin$rater)

#model 1 - lobe and rater as fixed effects and random int
thin_mod1 <- glmer(Value ~ Attribute  + rater + (1 | newID),
                data = thin,
                family = binomial(link = "logit"))
summary(thin_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(thin_mod1, ~ Attribute, type = "link")
pairs(emm)
```

```{r}
#model 2 - lobe as fixed effect, rater as random effect and random int
thin_mod2 <- glmer(Value ~ Attribute + (1 | newID) + (1 | rater),
                data = thin,
                family = binomial(link = "logit"))
summary(thin_mod2)
```

### Thick-wall Cavity

```{r}
#make sure everything is in correct format
thick$Value <- as.numeric(as.character(thick$Value))
thick$Attribute <- factor(thick$Attribute, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
thick$newID <- factor(thick$newID)
thick$rater <- factor(thick$rater)

#model 1 - lobe and rater as fixed effects and random int
thick_mod1 <- glmer(Value ~ Attribute + rater + (1 | newID),
                data = thick,
                family = binomial(link = "logit"))
summary(thick_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(thick_mod1, ~ Attribute, type = "link")
pairs(emm)
```

## Statistical Model Notation

$\lambda_{ijkl} = log(\frac{P(Score_{ijk} \leq l|b_i, b_{k(i)} )}{1-P(Score_{ijk }\leq l | b_i,b_{k(i)})}) = \alpha_l + \beta_1(lobe_j) + \beta_2(rater_k) + b_i + b_{k(i)}, \ where \ i=subject, \ j=lobe, \ k=rater, \ l=score \ level, \ b_i \sim N(0,\sigma^2_{subject}), \ and \ b_{k(i)} \sim N(0,\sigma^2_{subject \times rater}). \ Thus \ we \ have \ ICC=\frac{\sigma^2_{subject}}{\sigma^2_{subject} + \sigma^2_{subject \times rater}}$