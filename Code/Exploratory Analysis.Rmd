---
title: "Exploratory Analysis"
author: "Edward Bosko"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(MASS)
library(ggplot2)
library(brant)
library(emmeans)
```

## Purpose

This file will be used for exploratory analysis: evaluating the spread and distribution of the data, checking proportional odds assumption of simple models without random effects

## Reading in Data

### Tree-in-bud

```{r}
#read in data
tib <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "tib.long")

ggo <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "ggo.long")

cons <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "cons.long")

bronch <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "bronch.long")

atel <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "atel.long")

ln <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "ln.long")

thin <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "thin.long")

thick <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "thick.long")
```

## Visualize the Distribution of Scores

### Tree-in-bud

```{r}
#by rating 
tib %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(tib, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Tree-in-bud Ratings',
       x='Rating',
       y ='Count')

#by lobe
tib %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

tib %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of TIB Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

tib %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s TIB Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

tib %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s TIB Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Large Nodules - See "Questions for Ed" file for discrepancy with VH's "3" rating

```{r}
#by rating 
ln %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(ln, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Large Nodule Ratings',
       x='Rating',
       y ='Count')

#by lobe
ln %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ln %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of LN Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

ln %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s LN Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

ln %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s LN Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Ground-glass Opacities

```{r}
#by rating 
ggo %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(ggo, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Ground Glass Opacity Ratings',
       x='Rating',
       y ='Count')

#by lobe
ggo %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggo %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of GGO Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

ggo %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s GGO Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

ggo %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s GGO Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Consolidations

```{r}
#by rating 
cons %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(cons, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Consolidation Ratings',
       x='Rating',
       y ='Count')

#by lobe
cons %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

cons %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of Consolidation Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

cons %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s Consolidation Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

cons %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s Consolidation Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Bronchiectasis

```{r}
#by rating 
bronch %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(bronch, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Bronchiectasis Ratings',
       x='Rating',
       y ='Count')

#by lobe
bronch %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

bronch %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of Bronchiectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

bronch %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s Bronchiectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

bronch %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s Bronchiectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Atelectasis

```{r}
#by rating 
atel %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(atel, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Atelectasis Ratings',
       x='Rating',
       y ='Count')

#by lobe
atel %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

atel %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of Atelectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

atel %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s Atelectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

atel %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s Atelectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Thin Wall Cavity

```{r}
#by rating 
thin %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(thin, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Thin Wall Cavity Ratings',
       x='Rating',
       y ='Count')

#by lobe
thin %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

thin %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of Thin Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

thin %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s Thin Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

thin %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s Thin Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Thick Wall Cavity

```{r}
#by rating 
thick %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(thick, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Thick Wall Cavity Ratings',
       x='Rating',
       y ='Count')

#by lobe
thick %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

thick %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of Thick Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

thick %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s Thick Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

thick %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s Thick Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

## Heatmap

### Ordinal Outcomes

```{r}
# Add feature labels
tib$feature <- "TIB"
ggo$feature <- "GGO"
bronch$feature <- "Bronchiectasis"
cons$feature <- "Consolidation"
atel$feature <- "Atelectasis"

# Bind together
ordinal_data <- bind_rows(tib, ggo, bronch, cons, atel)

# Create heatmap data: average score per lobe and feature
heatmap_data_ordinal <- ordinal_data %>%
  group_by(lobe, feature) %>%
  summarize(mean_score = mean(score, na.rm = TRUE)) %>%
  ungroup()

ggplot(heatmap_data_ordinal, aes(x = feature, y = lobe, fill = mean_score)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Avg Score") +
  labs(
    title = "Average CT Score by Feature and Lobe (Ordinal Features)",
    x = "CT Feature",
    y = "Lung Lobe"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Binary Outcomes

```{r}
# Add feature labels
ln$feature <- "Large Nodules"
thin$feature <- "Thin-wall Cavity"
thick$feature <- "Thick-wall Cavity"

# Bind
binary_data <- bind_rows(ln, thin, thick)

# Create heatmap data
heatmap_data_binary <- binary_data %>%
  group_by(lobe, feature) %>%
  summarize(mean_score = mean(as.numeric(score), na.rm = TRUE)) %>%
  ungroup()

# Plot heatmap
ggplot(heatmap_data_binary, aes(x = feature, y = lobe, fill = mean_score)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightyellow", high = "red", name = "Proportion Present") +
  labs(
    title = "Proportion of Binary CT Feature Present by Lobe",
    x = "CT Feature",
    y = "Lung Lobe"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

## Small Multiples

```{r}
# Add feature label for each ordinal dataset
tib$feature <- "TIB"
ggo$feature <- "GGO"
bronch$feature <- "BRONCH"
cons$feature <- "CONS"
atel$feature <- "ATEL"

# Combine all ordinal features into one
ordinal_all <- bind_rows(tib, ggo, bronch, cons, atel)

# Clean and reformat
ordinal_all <- ordinal_all %>%
  mutate(
    score = as.numeric(as.character(score)),  # ensure numeric
    lobe = factor(lobe, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL")),
    feature = factor(feature, levels = c("TIB", "GGO", "CONS", "ATEL", "BRONCH"))
  )

# Create small multiples matrix of score distributions
ggplot(ordinal_all, aes(x = rater, y = score, fill = rater)) +
  geom_violin(scale = "width", adjust = 1, trim = FALSE, alpha = 0.6, color = NA) +
  geom_boxplot(width = 0.1, outlier.shape = NA, alpha = 0.9) +
  facet_grid(feature ~ lobe) +
  scale_y_continuous(breaks = c(0, 3)) +
  scale_fill_brewer(palette = "Set1") +
  labs(
    title = "Score Distributions by Lobe and CT Feature",
    x = "Rater",
    y = "Score"
  ) +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

```

## Simple Models without Random Effects; Lobe as only Fixed Effect

### Tree-in-bud

```{r}
tib_jw <- subset(tib, rater == "JW")

#convert score to an ordered factor (0 < 1 < 2 < 3)
tib_jw$score <- ordered(tib_jw$score, levels = c(0,1,2,3))

tib_jw$lobe <- factor(tib_jw$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
tib_polr <- polr(
  score ~ lobe, 
  data = tib_jw, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(tib_polr)

#check the proportional odds assumption with the brant test
brant(tib_polr)

#set up contrasts to compare lobes
tib_emm <- emmeans(tib_polr, ~ lobe)
tib_emm
pairs(tib_emm)
```

Proportional odds not violated

Significant differences:
LUS vs all other lobes
*RUL - LUS: OR = 2.95 => RUL's odds of disease are 2.95 times that of LUS
*RML - LUS: OR = 2.69 => RML's odds of disease are 2.69 times that of LUS
*RLL - LUS: OR = 3.45 => RLL's odds of disease are 3.45 times that of LUS
*LLS - LUS: OR = 2.22 => LLS's odds are 2.22 times that of LUS
*LLL - LUS: OR = 3.02 => LLL's odds are 3 times that of LUS

### Large Nodules

```{r}
#subset data for rater JW
ln_jw <- subset(ln, rater == "JW")

#ensure score is a factor with levels 0 and 1
ln_jw$score <- factor(ln_jw$score, levels = c(0,1))

#make lobe a factor in the desired order
ln_jw$lobe <- factor(ln_jw$lobe, 
                             levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit a standard logistic regression model (binary) 
ln_glm <- glm(score ~ lobe, 
                 data = ln_jw, 
                 family = binomial(link = "logit"))

#look at model summary 
summary(ln_glm)

#obtain estimated means (probabilities of score=1 by lobe)
ln_emm <- emmeans(ln_glm, ~ lobe, type = "response")

#see the pairwise comparisons
pairs(ln_emm)
```

Significant findings:
*RML - LLL: OR = 0.25 => RML's odds of disease is 0.25 times that of LLL
*LUS - LLL: OR = 0.28 => LUS's odds of disease is 0.28 times that of LLL
*LLS - LLL: OR = 0.31 => LLS's odds of disease is 0.31 times that of LLL

Borderline significant findings:
*RUL - RML: OR = 3.11 => RUL's odds of disease is 3.11 times that of RML
*RML - RLL: OR = 0.32 => RML's odds of disease is 0.32 times that of RLL

### Ground-glass Opacities

```{r}
ggo_jw <- subset(ggo, rater == "JW")

#convert score to an ordered factor (0 < 1 < 2 < 3)
ggo_jw$score <- ordered(ggo_jw$score, levels = c(0,1,2,3))

ggo_jw$lobe <- factor(ggo_jw$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
ggo_polr <- polr(
  score ~ lobe, 
  data = ggo_jw, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(ggo_polr)

#check the proportional odds assumption with the brant test
brant(ggo_polr)

#set up contrasts to compare lobes
ggo_emm <- emmeans(ggo_polr, ~ lobe)
ggo_emm
pairs(ggo_emm)
```

Proportional odds not violated

No significant differences between lobes

### Consolidations

```{r}
cons_jw <- subset(cons, rater == "JW")

#convert score to an ordered factor (0 < 1 < 2 < 3)
cons_jw$score <- ordered(cons_jw$score, levels = c(0,1,2,3))

cons_jw$lobe <- factor(cons_jw$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
cons_polr <- polr(
  score ~ lobe, 
  data = cons_jw, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(cons_polr)

#check the proportional odds assumption with the brant test
brant(cons_polr)

#set up contrasts to compare lobes
cons_emm <- emmeans(cons_polr, ~ lobe)
cons_emm
pairs(cons_emm)
```

Proportional odds assumption not violated

Significant findings:
*RUL - LUS: OR = 3.62 => RUL's odds of disease are 3.62 times that of LUS
*RML - LUS: OR = 3.14 => RML's odds of disease are 3.14 times that of LUS
*RLL - LUS: OR = 2.27 => RLL's odds of disease are 2.27 times that of LUS
*LLS - LUS: OR = 3.14 => LLS's odds of disease are 3.14 times that of LUS

Borderline significant: 
*RUL - LLL: OR = 1.9 => RUL's odds of disease are 1.9 times that of LLL

### Bronchiectasis

```{r}
bronch_jw <- subset(bronch, rater == "JW")

#convert score to an ordered factor (0 < 1 < 2 < 3)
bronch_jw$score <- ordered(bronch_jw$score, levels = c(0,1,2,3))

bronch_jw$lobe <- factor(bronch_jw$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
bronch_polr <- polr(
  score ~ lobe, 
  data = bronch_jw, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(bronch_polr)

#check the proportional odds assumption with the brant test
brant(bronch_polr)

#set up contrasts to compare lobes
bronch_emm <- emmeans(bronch_polr, ~ lobe)
bronch_emm
pairs(bronch_emm)
```

Proportional odds assumption violated at model-level (RML may be different across thresholds)

Significant findings:
*RUL - RML: OR = 0.39 => RUL's odds of disease are 0.39 times that of RML
*RUL - LUS: OR = 3.77 => RUL's odds of disease are 3.77 times that of LUS
*RUL - LLL: OR = 1.87 => RUL's odds of disease are 1.87 times that of LLL
*RML - RLL: OR = 3.16 => RML's odds of disease are 3.16 times that of RLL
*RML - LUS: OR = 9.54 => RML's odds of disease are 9.54 times that of LUS
*RML - LLL: OR = 4.75 => RML's odds of disease are 4.75 times that of LLL
*RLL - LUS: OR = 3.02 => RLL's odds of disease are 3.02 times that of LUS
*RLL - LLS: OR = 0.53 => RLL's odds of disease are 0.53 times that of LLS
*LUS - LLS: OR = 0.18 => LUS's odds of disease are 0.18 times that of LLS
*LUS - LLL: OR = 0.5 => LUS's odds of disease are about half of that of LLL
*LLS - LLL: OR = 2.83 => LLS's odds of disease are 2.83 times that of LLL

### Atelectasis

```{r}
atel_jw <- subset(atel, rater == "JW")

#convert score to an ordered factor (0 < 1 < 2 < 3)
atel_jw$score <- ordered(atel_jw$score, levels = c(0,1,2,3))

atel_jw$lobe <- factor(atel_jw$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
atel_polr <- polr(
  score ~ lobe, 
  data = atel_jw, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(atel_polr)

#check the proportional odds assumption with the brant test
brant(atel_polr)

#set up contrasts to compare lobes
atel_emm <- emmeans(atel_polr, ~ lobe)
atel_emm
pairs(atel_emm)
```

Proportional odds assumption holds

Significant findings:
*RUL - RML: OR = 0.22 => RUL's odds of disease are 0.22 times that of RML
*RUL - LUS: OR = 2.96 => RUL's odds of disease are 2.96 times that of LUS
*RUL - LLS: OR = 0.3 => RUL's odds of disease are 0.3 times that of LLS
*RML - RLL: OR = 11.46 => RML's odds of disease are 11.46 times that of RLL
*RML - LUS: OR = 13.43 => RML's odds of disease are 13.43 times that of LUS
*RML - LLL: OR = 10.59 => RML's odds of disease are 10.59 times that of LLL
*RLL - LLS: OR = 0.12 => RLL's odds of disease are 0.12 times that of LLS
*LUS - LLS: OR = 0.1 => LUS's odds of disease are 0.1 times that of LLS
*LLS - LLL: OR = 7.68 => LLS's odds of disease are 7.68 times that of LLL

### Thin Wall Cavity

```{r}
#subset data for rater JW
thin_jw <- subset(thin, rater == "JW")

#ensure score is a factor with levels 0 and 1
thin_jw$score <- factor(thin_jw$score, levels = c(0,1))

#make lobe a factor in the desired order
thin_jw$lobe <- factor(thin_jw$lobe, 
                             levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit a standard logistic regression model (binary) 
thin_glm <- glm(score ~ lobe, 
                 data = thin_jw, 
                 family = binomial(link = "logit"))

#look at model summary 
summary(thin_glm)

#obtain estimated means (probabilities of score=1 by lobe)
thin_emm <- emmeans(thin_glm, ~ lobe, type = "response")

#see the pairwise comparisons
pairs(thin_emm)
```

Lobes do not significantly differ


### Thick Wall Cavity

```{r}
#subset data for rater JW
thick_jw <- subset(thick, rater == "JW")

#ensure score is a factor with levels 0 and 1
thick_jw$score <- factor(thick_jw$score, levels = c(0,1))

#make lobe a factor in the desired order
thick_jw$lobe <- factor(thick_jw$lobe, 
                             levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit a standard logistic regression model (binary) 
thick_glm <- glm(score ~ lobe, 
                 data = thick_jw, 
                 family = binomial(link = "logit"))

#look at model summary 
summary(thick_glm)

#obtain estimated means (probabilities of score=1 by lobe)
thick_emm <- emmeans(thick_glm, ~ lobe, type = "response")

#see the pairwise comparisons
pairs(thick_emm)
```

Significant findings:
*RUL - RML: OR = 10.62 => RUL's odds of disease are 10.62 times that of RML
*RUL - LUS: OR = 3.85 => RUL's odds of disease are 3.85 times that of LUS
*RUL - LLS: OR = 7.91 => RUL's odds of disease are 7.91 times that of LLS
*RUL - LLL: OR = 4.43 =>  RUL's odds of diseasea re 4.43 times that of LLL

## Simple Models without Random Effects; Lobe and Rater as Fixed Effects

### Tree-in-bud

```{r}
#convert score to an ordered factor (0 < 1 < 2 < 3)
tib$score <- ordered(tib$score, levels = c(0,1,2,3))

tib$lobe <- factor(tib$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
tib_polr <- polr(
  score ~ lobe + rater, 
  data = tib, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(tib_polr)

#check the proportional odds assumption with the brant test
brant(tib_polr)

#set up contrasts to compare lobes
tib_emm <- emmeans(tib_polr, ~ lobe)
tib_emm
pairs(tib_emm)
```

Proportional odds violated

Significant differences:
LUS vs all other lobes
*RUL - LUS: OR = 2.19 => RUL's odds of disease is 2.19 times that of LUS
*RML - LUS: OR = 2.45 => RML's odds of disease is 2.45 times that of LUS
*RLL - LUS: OR = 3.14 => RLL's odds of disease is 3.14 times that of LUS
*RLL - LLS: OR = 1.68 => RLL's odds of disease is 1.68 times that of LUS
*LUS - LLS: OR = 0.54 => LUS's odds of disease is 0.54 times that of LLS
*LUS - LLL: OR = 0.37 => LLL's odds of disease is 0.37 times that of LUS

### Large Nodules

```{r}
#ensure score is a factor with levels 0 and 1
ln$score <- factor(ln$score, levels = c(0,1))

#make lobe a factor in the desired order
ln$lobe <- factor(ln$lobe, 
                             levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit a standard logistic regression model (binary) 
ln_glm <- glm(score ~ lobe + rater, 
                 data = ln, 
                 family = binomial(link = "logit"))

#look at model summary 
summary(ln_glm)

#obtain estimated means (probabilities of score=1 by lobe)
ln_emm <- emmeans(ln_glm, ~ lobe, type = "response")

#see the pairwise comparisons
pairs(ln_emm)
```

Significant findings:
*RUL - RML: OR = 2.73 => RUL's odds of disease is 2.73 times that of RML
*RUL - LUS: OR = 2.94 => RUL's odds of disease is 2.94 times that of LUS
*RUL - LLS: OR = 2.73 => RUL's odds of disease is 2.73 times that of LLS
*RML - RLL: OR = 0.35 => RML's odds of disease is 0.35 times that of RLL
*RML - LLL: OR = 0.32 => RML's odds of disease is 0.32 times that of LLL
*RLL - LUS: OR = 3.06 => RLL's odds of disease is 3.06 times that of LUS
*RLL - LLS: OR = 2.84 => RLL's odds of disease is 2.84 times that of LLS
*LUS - LLL: OR = 0.30 => LUS's odds of disease is 0.30 times that of LLL
*LLS - LLL: OR = 0.32 => LLS's odds of disease is 0.32 times that of LLL

### Ground-glass Opacities

```{r}
#convert score to an ordered factor (0 < 1 < 2 < 3)
ggo$score <- ordered(ggo$score, levels = c(0,1,2,3))

ggo$lobe <- factor(ggo$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
ggo_polr <- polr(
  score ~ lobe + rater, 
  data = ggo, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(ggo_polr)

#check the proportional odds assumption with the brant test
brant(ggo_polr)

#set up contrasts to compare lobes
ggo_emm <- emmeans(ggo_polr, ~ lobe)
ggo_emm
pairs(ggo_emm)
```

Proportional odds not violated

No significant differences between lobes

### Consolidations

```{r}
#convert score to an ordered factor (0 < 1 < 2 < 3)
cons$score <- ordered(cons$score, levels = c(0,1,2,3))

cons$lobe <- factor(cons$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
cons_polr <- polr(
  score ~ lobe + rater, 
  data = cons, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(cons_polr)

#check the proportional odds assumption with the brant test
brant(cons_polr)

#set up contrasts to compare lobes
cons_emm <- emmeans(cons_polr, ~ lobe)
cons_emm
pairs(cons_emm)
```

Proportional odds assumption not violated

Significant findings:
*RUL - LUS: OR = 3.03 => RUL's odds of disease is 3.03 times that of LUS
*RUL - LLL: OR = 1.74 => RUL's odds of disease is 1.74 times that of LLL
*RML - LUS: OR = 3.38 => RML's odds of disease is 3.38 times that of LUS
*RML - LLL: OR = 1.93 => RML's odds of disease is 1.93 times that of LLL
*RLL - LUS: OR = 2.11 => RLL's odds of disease is 2.11 times that of LUS
*LUS - LLS: OR = 0.35 => LUS's odds of disease is 0.35 times that of LLS

### Bronchiectasis

```{r}
#convert score to an ordered factor (0 < 1 < 2 < 3)
bronch$score <- ordered(bronch$score, levels = c(0,1,2,3))

bronch$lobe <- factor(bronch$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
bronch_polr <- polr(
  score ~ lobe + rater, 
  data = bronch, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(bronch_polr)

#check the proportional odds assumption with the brant test
brant(bronch_polr)

#set up contrasts to compare lobes
bronch_emm <- emmeans(bronch_polr, ~ lobe)
bronch_emm
pairs(bronch_emm)
```

Proportional odds assumption violated

Significant findings:
*RUL - RML: OR = 0.42 => RUL's odds of disease is 0.42 times that of RML
*RUL - LUS: OR = 3.03 => RUL's odds of disease is 3.03 times that of LUS
*RUL - LLL: OR = 1.70 => RUL's odds of disease is 1.70 times that of LLL
*RML - RLL: OR = 2.80 => RML's odds of disease is 2.80 times that of RLL
*RML - LUS: OR = 7.21 => RML's odds of disease is 7.21 times that of LUS
*RML - LLS: OR = 1.68 => RML's odds of disease is 1.68 times that of LLS
*RML - LLL: OR = 4.05 => RML's odds of disease is 4.05 times that of LLL
*RLL - LUS: OR = 2.58 => RLL's odds of disease is 2.58 times that of LUS
*RLL - LLS: OR = 0.60 => RLL's odds of disease is 0.60 times that of LLS
*LUS - LLS: OR = 0.23 => LUS's odds of disease is 0.23 times that of LLS
*LUS - LLL: OR = 0.56 => LUS's odds of disease is 0.56 times that of LLL
*LLS - LLL: OR = 2.41 => LLS's odds of disease is 2.41 times that of LLL

### Atelectasis

```{r}
#convert score to an ordered factor (0 < 1 < 2 < 3)
atel$score <- ordered(atel$score, levels = c(0,1,2,3))

atel$lobe <- factor(atel$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit simple PO model, ignoring REs
atel_polr <- polr(
  score ~ lobe + rater, 
  data = atel, 
  method = "logistic", 
  Hess = TRUE
)

#look at summary of results
summary(atel_polr)

#check the proportional odds assumption with the brant test
brant(atel_polr)

#set up contrasts to compare lobes
atel_emm <- emmeans(atel_polr, ~ lobe)
atel_emm
pairs(atel_emm)
```

Proportional odds assumption holds

Significant findings:
*RUL - RML: OR = 0.18 => RUL's odds of disease is 0.22 times that of RML
*RUL - RLL: OR = 2.47 => RUL's odds of disease is 2.47 times that of RLL
*RUL - LUS: OR = 2.43 => RUL's odds of disease is 2.43 times that of LUS
*RUL - LLS: OR = 0.25 => RUL's odds of disease is 0.25 times that of LLS
*RML - RLL: OR = 13.4 => RML's odds of disease is 13.4 times that of RLL
*RML - LUS: OR = 13.2 => RML's odds of disease is 13.2 times that of LUS
*RML - LLL: OR = 10.8 => RML's odds of disease is 10.8 times that of LLL
*RLL - LLS: OR = 0.10 => RLL's odds of disease is 0.10 times that of LLS
*LUS - LLS: OR = 0.10 => LUS's odds of disease is 0.10 times that of LLS
*LLS - LLL: OR = 7.96 => LLS's odds of disease is 7.96 times that of LLL

### Thin Wall Cavity

```{r}
#ensure score is a factor with levels 0 and 1
thin$score <- factor(thin$score, levels = c(0,1))

#make lobe a factor in the desired order
thin$lobe <- factor(thin$lobe, 
                             levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit a standard logistic regression model (binary) 
thin_glm <- glm(score ~ lobe + rater, 
                 data = thin, 
                 family = binomial(link = "logit"))

#look at model summary 
summary(thin_glm)

#obtain estimated means (probabilities of score=1 by lobe)
thin_emm <- emmeans(thin_glm, ~ lobe, type = "response")

#see the pairwise comparisons
pairs(thin_emm)
```

Lobes do not significantly differ


### Thick Wall Cavity

```{r}
#ensure score is a factor with levels 0 and 1
thick$score <- factor(thick$score, levels = c(0,1))

#make lobe a factor in the desired order
thick$lobe <- factor(thick$lobe, 
                             levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))

#fit a standard logistic regression model (binary) 
thick_glm <- glm(score ~ lobe + rater, 
                 data = thick, 
                 family = binomial(link = "logit"))

#look at model summary 
summary(thick_glm)

#obtain estimated means (probabilities of score=1 by lobe)
thick_emm <- emmeans(thick_glm, ~ lobe, type = "response")

#see the pairwise comparisons
pairs(thick_emm)
```

Significant findings:
*RUL - RML: OR = 10.4 => RUL's odds of disease is 10.4 times that of RML
*RUL - RLL: OR = 2.48 => RUL's odds of disease is 2.48 times that of RLL
*RUL - LUS: OR = 4.07 => RUL's odds of disease is 4.07 times that of LUS
*RUL - LLS: OR = 10.4 => RUL's odds of disease is 10.4 times that of LLS
*RUL - LLL: OR = 3.68 => RUL's odds of disease is 3.68 times that of LLL