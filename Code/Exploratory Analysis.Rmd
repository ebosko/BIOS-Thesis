---
title: "Exploratory Analysis"
author: "Edward Bosko"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=F, message=F}
library(tidyverse)
library(readxl)
library(MASS)
library(ggplot2)
library(brant)
library(emmeans)
```

## Purpose

This file will be used for exploratory analysis: evaluating the spread and distribution of the data, checking proportional odds assumption of simple models without random effects, generating summary statistics of demographic data

## Reading in Data

```{r, warning=F, message=F}
#read in data
tib <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "tib.long")

ggo <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "ggo.long")

cons <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "cons.long")

bronch <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "bronch.long")

atel <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "atel.long")

ln <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "ln.long")

thin <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "thin.long")

thick <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "thick.long")

demo <- read.csv('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataRaw/demographic_final.csv')

flat <- read.csv('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataRaw/demographic_final.csv')
```

## Visualize the Distribution of Scores

### Tree-in-bud

```{r}
score_colors_new <- c(
  "3" = "#E34A33",  # Orange-Red for Score 3
  "2" = "#3B9142",  # Green for Score 2
  "1" = "#5EC9C2",  # Light Blue for Score 1
  "0" = "#be64ac"   # white for Score 0
)

#by rating 
tib %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(tib, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Tree-in-bud Ratings',
       x='Rating',
       y ='Count')

#by lobe
tib %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

tib %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of TIB Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

tib %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of JW\'s TIB Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

tib %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of VH\'s TIB Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Large Nodules

```{r}
#by rating 
ln %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(ln, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Large Nodule Ratings',
       x='Rating',
       y ='Count')

#by lobe
ln %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ln %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of LN Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

ln %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s LN Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

ln %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s LN Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Ground-glass Opacities

```{r}
#by rating 
ggo %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(ggo, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Ground Glass Opacity Ratings',
       x='Rating',
       y ='Count')

#by lobe
ggo %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggo %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of GGO Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

ggo %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of JW\'s GGO Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

ggo %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of VH\'s GGO Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Consolidations

```{r}
#by rating 
cons %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(cons, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Consolidation Ratings',
       x='Rating',
       y ='Count')

#by lobe
cons %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

cons %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of Consolidation Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

cons %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of JW\'s Consolidation Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

cons %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of VH\'s Consolidation Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Bronchiectasis

```{r}
#by rating 
bronch %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(bronch, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Bronchiectasis Ratings',
       x='Rating',
       y ='Count')

#by lobe
bronch %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

bronch %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of Bronchiectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

bronch %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of JW\'s Bronchiectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

bronch %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of VH\'s Bronchiectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Atelectasis

```{r}
#by rating 
atel %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(atel, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Atelectasis Ratings',
       x='Rating',
       y ='Count')

#by lobe
atel %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

atel %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of Atelectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

atel %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of JW\'s Atelectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

atel %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  scale_fill_manual(values = score_colors_new) +
  labs(
    title = 'Distribution of VH\'s Atelectasis Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Thin Wall Cavity

```{r}
#by rating 
thin %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(thin, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Thin Wall Cavity Ratings',
       x='Rating',
       y ='Count')

#by lobe
thin %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

thin %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of Thin Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

thin %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s Thin Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

thin %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s Thin Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

### Thick Wall Cavity

```{r}
#by rating 
thick %>%
  group_by(rater, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

ggplot(thick, aes(x=factor(score), fill=rater)) +
  geom_bar(position = 'dodge') +
  labs(title = 'Distribution of Thick Wall Cavity Ratings',
       x='Rating',
       y ='Count')

#by lobe
thick %>%
  group_by(lobe, score) %>%
  summarize(n=n()) %>%
  mutate(prop = n / sum(n))

thick %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of Thick Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

thick %>%
  filter(rater == 'JW') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of JW\'s Thick Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()

thick %>%
  filter(rater == 'VH') %>%
  mutate(score = factor(score, levels = c(3,2,1,0)),
         lobe = factor(lobe, levels = c('RUL','RML','RLL','LUS','LLS','LLL'))) %>%
  ggplot(aes (x=lobe, fill = factor(score))) +
  geom_bar(position = 'stack') + 
  labs(
    title = 'Distribution of VH\'s Thick Wall Cavity Ratings by Lobe',
    x='Lobe',
    y='Count',
    fill='Rating'
  ) +
  theme_minimal()
```

