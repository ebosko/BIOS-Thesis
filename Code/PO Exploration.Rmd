---
title: "PO Exploration"
author: "Edward Bosko"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=F, message=F}
library(tidyverse)
library(readxl)
library(MASS)
library(ggplot2)
library(brant)
library(emmeans)
library(ordinal)
```

## Reading in Data

```{r, warning=F, message=F}
#read in data
tib <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "tib.long")

ggo <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "ggo.long")

cons <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "cons.long")

bronch <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "bronch.long")

atel <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "atel.long")

ln <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "ln.long")

thin <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "thin.long")

thick <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "thick.long")

demo <- read.csv('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataRaw/demographic_final.csv')

flat <- read.csv('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataRaw/demographic_final.csv')
```

## Fitting Models

```{r}
#convert score to an ordered factor (0 < 1 < 2 < 3)
tib$score <- ordered(tib$score, levels = c(0,1,2,3))

tib$lobe <- factor(tib$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
tib$id <- factor(tib$id)


ctrl <- clmm2.control(method = "nlminb",
                      maxIter = 10000)

tib_npo <- clmm2(score ~ 1,
               random   = id,
               nominal  = ~ lobe + rater,
               data     = tib,
               link     = "logistic",
               Hess     = TRUE,
               control  = ctrl,
               nAGQ = 7)
```

```{r}
summary(tib_npo)
```

```{r}
#convert score to an ordered factor (0 < 1 < 2 < 3)
bronch$score <- ordered(bronch$score, levels = c(0,1,2,3))

bronch$lobe <- factor(bronch$lobe, 
                           levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
bronch$id <- factor(bronch$id)


ctrl <- clmm2.control(method = "nlminb",
                      maxIter = 10000)

bronch_npo <- clmm2(score ~ 1,
               random   = id,
               nominal  = ~ lobe + rater,
               data     = bronch,
               link     = "logistic",
               Hess     = TRUE,
               control  = ctrl)
```

```{r}
summary(bronch_npo)
```

## Performing Comparisons

```{r}
## ── 1  HELPER ---------------------------------------------------------------
pairwise_npo <- function(clmm_fit,
                         lobes      = c("RUL","RML","RLL","LUS","LLS","LLL"),
                         thresholds = c("0|1","1|2","2|3"),
                         alpha      = 0.05) {

  ## coefficients and (co)variances ------------------------------------------
  b      <- clmm_fit$coef                      # named vector
  V      <- solve(clmm_fit$Hessian)            # vcov matrix
  coef_n <- names(b)

  ## convenience look-up that returns 0 / 0 variance for baseline -------------
  get_coef <- function(thr,lobe) {
    nm <- paste0(thr,".lobe",lobe)
    if (nm %in% coef_n) {
      list(est = b[nm],
           var = V[nm,nm],
           cov = function(other) V[nm, other])   # returns a function
    } else {
      list(est = 0,
           var = 0,
           cov = function(other) 0)
    }
  }

  ## all unordered lobe pairs -------------------------------------------------
  comps <- combn(lobes, 2, simplify = FALSE)

  ## build results ------------------------------------------------------------
  out <- purrr::map_dfr(thresholds, function(thr) {

    purrr::map_dfr(comps, function(pair) {
      A <- pair[1]; B <- pair[2]

      cA <- get_coef(thr, A)
      cB <- get_coef(thr, B)
      est   <- cA$est - cB$est
      var   <- cA$var + cB$var - 2 * cA$cov(paste0(thr, ".lobe", B))
      se    <- sqrt(var)
      z     <- est / se
      p_raw <- 2 * pnorm(-abs(z))

      tibble::tibble(
        Comparison = sprintf("%s %s vs %s %s", B, thr, A, thr),
        Odds_Ratio = exp(est),
        OR_LowerCI = exp(est - qnorm(1 - alpha/2) * se),
        OR_UpperCI = exp(est + qnorm(1 - alpha/2) * se),
        raw_p      = p_raw
      )
    })
  })

  ## Benjamini–Hochberg FDR ----------------------------------------------------
  out <- out %>%
    dplyr::arrange(raw_p) %>%
    dplyr::mutate(BH_adj_p = p.adjust(raw_p, method = "BH")) %>%
    dplyr::arrange(BH_adj_p)

  return(out)
}

```

```{r}
results <- pairwise_npo(tib_npo)

## View, print, or write to Excel
print(results, n = 45)

# writexl::write_xlsx(results,
#   path = "Pairwise_NPO_lobe_comparisons.xlsx",
#   sheet = "tib_npo")

```

