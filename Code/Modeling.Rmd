---
title: "Models"
author: "Edward Bosko"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(readxl)
library(ggplot2)
library(emmeans)
library(ordinal)
library(nlme)
library(glmmTMB)
library(brms)
library(multgee)
library(lme4)
library(geepack)
```

## Purpose

This file will be used to compare different models for each CT feature

## Reading in Data

```{r}
#read in data
tib <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "tib.long")

ggo <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "ggo.long")

cons <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "cons.long")

bronch <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "bronch.long")

atel <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "atel.long")

ln <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "ln.long")

thin <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "thin.long")

thick <- read_excel('C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/DataProcessed/2025.4.2.xlsx', sheet = "thick.long")
```

## Models

### Tree-in-bud

```{r}
#make sure everything is in correct format
tib$score <- ordered(tib$score, levels = c(0,1,2,3))
tib$lobe <- factor(tib$lobe, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
tib$id <- factor(tib$id)
tib$rater <- factor(tib$rater)

#model 1 - lobe and rater as fixed effects and random int
tib_mod1 <- clmm(
  score ~ lobe + rater + (1 | id),
  data = tib
)

summary(tib_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(tib_mod1, ~ lobe, type = "link")
pairs(emm)
```

### Large Nodules

```{r}
#make sure everything is in correct format
ln$score <- as.numeric(as.character(ln$score))
ln_clean <- ln %>% filter(score %in% c(0, 1))
ln$lobe <- factor(ln$lobe, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
ln$id <- factor(ln$id)
ln$rater <- factor(ln$rater)

#model 1 - lobe and rater as fixed effects and random int
ln_mod1 <- glmer(score ~ lobe + rater + (1 | id),
                data = ln_clean,
                family = binomial(link = "logit"))
summary(ln_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(ln_mod1, ~ lobe, type = "link")
pairs(emm)
```

### Ground-glass Opacities

```{r}
#make sure everything is in correct format
ggo$score <- ordered(ggo$score, levels = c(0,1,2,3))
ggo$lobe <- factor(ggo$lobe, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
ggo$id <- factor(ggo$id)
ggo$rater <- factor(ggo$rater)

#model 1 - lobe and rater as fixed effects and random int
ggo_mod1 <- clmm(
  score ~ lobe + rater + (1 | id),
  data = ggo
)

summary(ggo_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(ggo_mod1, ~ lobe, type = "link")
pairs(emm)
```

### Consolidations

```{r}
#make sure everything is in correct format
cons$score <- ordered(cons$score, levels = c(0,1,2,3))
cons$lobe <- factor(cons$lobe, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
cons$id <- factor(cons$id)
cons$rater <- factor(cons$rater)

#model 1 - lobe and rater as fixed effects and random int
cons_mod1 <- clmm(
  score ~ lobe + rater + (1 | id),
  data = cons
)

summary(cons_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(cons_mod1, ~ lobe, type = "link")
pairs(emm)
```

### Bronchiectasis

```{r}
#make sure everything is in correct format
bronch$score <- ordered(bronch$score, levels = c(0,1,2,3))
bronch$lobe <- factor(bronch$lobe, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
bronch$id <- factor(bronch$id)
bronch$rater <- factor(bronch$rater)

#model 1 - lobe and rater as fixed effects and random int
bronch_mod1 <- clmm(
  score ~ lobe + rater + (1 | id),
  data = bronch
)

summary(bronch_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(bronch_mod1, ~ lobe, type = "link")
pairs(emm)
```

### Atelectasis

```{r}
#make sure everything is in correct format
atel$score <- ordered(atel$score, levels = c(0,1,2,3))
atel$lobe <- factor(atel$lobe, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
atel$id <- factor(atel$id)
atel$rater <- factor(atel$rater)

#model 1 - lobe and rater as fixed effects and random int
atel_mod1 <- clmm(
  score ~ lobe + rater + (1 | id),
  data = atel
)

summary(atel_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(atel_mod1, ~ lobe, type = "link")
pairs(emm)
```

### Thin-wall Cavity

```{r}
#make sure everything is in correct format
thin$score <- as.numeric(as.character(thin$score))
thin$lobe <- factor(thin$lobe, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
thin$id <- factor(thin$id)
thin$rater <- factor(thin$rater)

#model 1 - lobe and rater as fixed effects and random int
thin_mod1 <- glmer(score ~ lobe  + rater + (1 | id),
                data = thin,
                family = binomial(link = "logit"))
summary(thin_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(thin_mod1, ~ lobe, type = "link")
pairs(emm)
```

```{r}
#model 2 - lobe as fixed effect, rater as random effect and random int
thin_mod2 <- glmer(score ~ lobe + (1 | id) + (1 | rater),
                data = thin,
                family = binomial(link = "logit"))
summary(thin_mod2)
```

### Thick-wall Cavity

```{r}
#make sure everything is in correct format
thick$score <- as.numeric(as.character(thick$score))
thick$lobe <- factor(thick$lobe, levels = c("RUL", "RML", "RLL", "LUS", "LLS", "LLL"))
thick$id <- factor(thick$id)
thick$rater <- factor(thick$rater)

#model 1 - lobe and rater as fixed effects and random int
thick_mod1 <- glmer(score ~ lobe + rater + (1 | id),
                data = thick,
                family = binomial(link = "logit"))
summary(thick_mod1)
```

```{r}
#compute pairwise comparisons
emm <- emmeans(thick_mod1, ~ lobe, type = "link")
pairs(emm)
```

## Statistical Model Notation

$\lambda_{ijkl} = log(\frac{P(Score_{ijk} \leq l|b_i, b_{k(i)} )}{1-P(Score_{ijk }\leq l | b_i,b_{k(i)})}) = \alpha_l + \beta_1(lobe_j) + \beta_2(rater_k) + b_i + b_{k(i)}, \ where \ i=subject, \ j=lobe, \ k=rater, \ l=score \ level, \ b_i \sim N(0,\sigma^2_{subject}), \ and \ b_{k(i)} \sim N(0,\sigma^2_{subject \times rater}). \ Thus \ we \ have \ ICC=\frac{\sigma^2_{subject}}{\sigma^2_{subject} + \sigma^2_{subject \times rater}}$