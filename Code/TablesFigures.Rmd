---
title: "Figures"
author: "Edward Bosko"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Figures

```{r}
library(readxl)
library(dplyr)
library(purrr)
library(tidyr)
library(stringr)
library(writexl)
library(tidytext)
library(ggplot2)
```

```{r}
folder <- "C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal"

feature_rgx <- "(.*)\\.xlsx$"
slice_rgx   <- "(PO_main|PO_reduced|NPO_0to1|NPO_1to2|NPO_2to3)"

all_OR <- list.files(folder, pattern = "\\.xlsx$", full.names = TRUE) %>%
  map_dfr(function(path) {

    feature <- str_match(basename(path), feature_rgx)[, 2]

    readxl::excel_sheets(path) %>%
      keep(~ str_detect(.x, slice_rgx)) %>%
      map_dfr(function(sh) {

        dat <- read_excel(path, sheet = sh) %>%
          transmute(
            Comparison = Comparison,
            OR         = Odds_Ratio,
            OR_low     = OR_LowerCI,
            OR_high    = OR_UpperCI
          )

        dat %>%
          mutate(
            Feature = feature,
            slice   = case_when(
              sh == "PO_main"    ~ "PO main",
              sh == "PO_reduced" ~ "PO reduced",
              sh == "NPO_0to1"   ~ "NPO 0→1",
              sh == "NPO_1to2"   ~ "NPO 1→2",
              sh == "NPO_2to3"   ~ "NPO 2→3"
            )
          )
      })
  }) %>%
  mutate(
    slice = factor(
      slice,
      levels = c("PO main", "PO reduced", "NPO 0→1", "NPO 1→2", "NPO 2→3")
    )
  )

#wide comparison table
table_wide <- all_OR %>%
  mutate(
    OR_fmt = sprintf("%.2f (%.2f–%.2f)", OR, OR_low, OR_high)
  ) %>%
  dplyr::select(Feature, Comparison, slice, OR_fmt) %>%
  tidyr::pivot_wider(names_from = slice, values_from = OR_fmt) %>%
  arrange(Feature, Comparison)

#save
writexl::write_xlsx(table_wide,
                    path = file.path(folder, "Combined_OR_Table.xlsx"))
```

```{r}
table_wide <- all_OR %>%
  mutate(OR_fmt = sprintf("%.2f (%.2f–%.2f)", OR, OR_low, OR_high)) %>%
  dplyr::select(Feature, Comparison, slice, OR_fmt) %>%
  tidyr::pivot_wider(names_from = slice, values_from = OR_fmt) %>%
  arrange(Feature, Comparison)

#save to Excel
writexl::write_xlsx(table_wide, "Combined_OR_Table.xlsx")

```

### Tree-in-bud

```{r}
feature_file <- file.path(folder, "tib.xlsx")

slice_rgx <- "(PO_main|PO_reduced|NPO_0to1|NPO_1to2|NPO_2to3)"

plot_df <- excel_sheets(feature_file) %>%
  keep(~ str_detect(.x, slice_rgx)) %>%
  map_dfr(function(sh) {

    read_excel(feature_file, sheet = sh) %>%
      transmute(
        Comparison,
        OR      = Odds_Ratio,
        OR_low  = OR_LowerCI,
        OR_high = OR_UpperCI,
        FDR_p   = FDR_p,
        slice   = case_when(
          sh == "PO_main"    ~ "PO Full",
          sh == "PO_reduced" ~ "PO Reduced",
          sh == "NPO_0to1"   ~ "NPO 0→1",
          sh == "NPO_1to2"   ~ "NPO 1→2",
          sh == "NPO_2to3"   ~ "NPO 2→3"
        )
      )
  }) %>%
  mutate(
    slice = factor(slice,
      levels = c("PO Full","PO Reduced","NPO 0→1","NPO 1→2","NPO 2→3")),
    sig   = FDR_p < 0.05
  )

#PO-only figure
plot_PO <- plot_df %>%
  filter(slice %in% c("PO Full","PO Reduced")) %>%
  ggplot(aes(x = OR,
             y = factor(Comparison, levels = rev(unique(Comparison))),
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  scale_x_log10(breaks = c(.25,.5,1,2,4,8),
                limits = c(.2, max(plot_df$OR_high)*1.05)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .35), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – PO Models (Tree-in-bud)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() + theme(legend.position = "bottom",
                     axis.text.y = element_text(size = 7))

#NPO figure with facets
plot_NPO <- plot_df %>% 
  filter(str_detect(slice, "^NPO")) %>% 
  mutate(Comparison = reorder_within(Comparison,
                                     -row_number(),
                                     slice)) %>% 
  ggplot(aes(x = OR,
             y = Comparison,
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  facet_wrap(~ slice, ncol = 1, scales = "free_y") +
  scale_y_reordered() +
  scale_x_log10(breaks = c(.25, .5, 1, 2, 4, 8, 16, 32, 64),
                limits = c(.2, max(plot_df$OR_high) * 1.05)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .30), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – NPO Cut-Points (Tree-in-bud)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() +
  theme(strip.text  = element_text(face = "bold"),
        axis.text.y = element_text(size = 7))


#save
ggsave(file.path(folder, "TIB_PO_forest.png"),  plot_PO,
       width = 7, height = 8, dpi = 300)
ggsave(file.path(folder, "TIB_NPO_forest.png"), plot_NPO,
       width = 7, height = 10, dpi = 300)

```

### Large Nodules

```{r}
feature_file <- file.path(folder, "ln.xlsx")

slice_rgx <- "(PO_main)"

plot_df <- excel_sheets(feature_file) %>%
  keep(~ str_detect(.x, slice_rgx)) %>%
  map_dfr(function(sh) {

    read_excel(feature_file, sheet = sh) %>%
      transmute(
        Comparison,
        OR      = Odds_Ratio,
        OR_low  = OR_LowerCI,
        OR_high = OR_UpperCI,
        FDR_p   = FDR_p,
        slice   = case_when(
          sh == "PO_main"    ~ "Reduced"
        )
      )
  }) %>%
  mutate(
    slice = factor(slice),
      levels = c("Reduced"),
    sig   = FDR_p < 0.05
  )

#PO-only figure
plot_PO <- plot_df %>%
  filter(slice %in% c("Reduced")) %>%
  ggplot(aes(x = OR,
             y = factor(Comparison, levels = rev(unique(Comparison))),
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  scale_x_log10(breaks = c(.25,.5,1,2,4,8),
                limits = c(.2, max(plot_df$OR_high)*1.05)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .35), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – Reduced Model (Large Nodules)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() + theme(legend.position = "bottom",
                     axis.text.y = element_text(size = 7))

#save
ggsave(file.path(folder, "LN_PO_forest.png"),  plot_PO,
       width = 7, height = 8, dpi = 300)

```

### Ground-glass opacities

```{r}
feature_file <- file.path(folder, "ggo.xlsx")

slice_rgx <- "(PO_main|PO_reduced)"

plot_df <- excel_sheets(feature_file) %>%
  keep(~ str_detect(.x, slice_rgx)) %>%
  map_dfr(function(sh) {

    read_excel(feature_file, sheet = sh) %>%
      transmute(
        Comparison,
        OR      = Odds_Ratio,
        OR_low  = OR_LowerCI,
        OR_high = OR_UpperCI,
        FDR_p   = FDR_p,
        slice   = case_when(
          sh == "PO_main"    ~ "Full",
          sh == "PO_reduced" ~ "Reduced"
        )
      )
  }) %>%
  mutate(
    slice = factor(slice,
      levels = c("Full","Reduced")),
    sig   = FDR_p < 0.05
  )

#PO-only figure
plot_PO <- plot_df %>%
  filter(slice %in% c("Full","Reduced")) %>%
  ggplot(aes(x = OR,
             y = factor(Comparison, levels = rev(unique(Comparison))),
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  scale_x_log10(breaks = c(.25,.5,1,2,4,8),
                limits = c(.2, max(plot_df$OR_high)*1.05)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .35), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – Full & Reduced Models (Ground-Glass Opacity)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() + theme(legend.position = "bottom",
                     axis.text.y = element_text(size = 7))

#save
ggsave(file.path(folder, "GGO_PO_forest.png"),  plot_PO,
       width = 7, height = 8, dpi = 300)

```

### Consolidation

```{r}
feature_file <- file.path(folder, "cons.xlsx")

slice_rgx <- "(PO_main|PO_reduced)"

plot_df <- excel_sheets(feature_file) %>%
  keep(~ str_detect(.x, slice_rgx)) %>%
  map_dfr(function(sh) {

    read_excel(feature_file, sheet = sh) %>%
      transmute(
        Comparison,
        OR      = Odds_Ratio,
        OR_low  = OR_LowerCI,
        OR_high = OR_UpperCI,
        FDR_p   = FDR_p,
        slice   = case_when(
          sh == "PO_main"    ~ "PO Full",
          sh == "PO_reduced" ~ "PO Reduced"
        )
      )
  }) %>%
  mutate(
    slice = factor(slice,
      levels = c("PO Full","PO Reduced")),
    sig   = FDR_p < 0.05
  )

#PO-only figure
plot_PO <- plot_df %>%
  filter(slice %in% c("PO Full","PO Reduced")) %>%
  ggplot(aes(x = OR,
             y = factor(Comparison, levels = rev(unique(Comparison))),
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  scale_x_log10(breaks = c(.25,.5,1,2,4,8),
                limits = c(.2, max(plot_df$OR_high)*1.05)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .35), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – PO Models (Consolidation)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() + theme(legend.position = "bottom",
                     axis.text.y = element_text(size = 7))

#save
ggsave(file.path(folder, "CONS_PO_forest.png"),  plot_PO,
       width = 7, height = 8, dpi = 300)

```

### Bronchiectasis

```{r}
feature_file <- file.path(folder, "bronch.xlsx")

slice_rgx <- "(PO_main|PO_reduced|NPO_0to1|NPO_1to2|NPO_2to3)"

plot_df <- excel_sheets(feature_file) %>%
  keep(~ str_detect(.x, slice_rgx)) %>%
  map_dfr(function(sh) {

    read_excel(feature_file, sheet = sh) %>%
      transmute(
        Comparison,
        OR      = Odds_Ratio,
        OR_low  = OR_LowerCI,
        OR_high = OR_UpperCI,
        FDR_p   = FDR_p,
        slice   = case_when(
          sh == "PO_main"    ~ "PO Full",
          sh == "PO_reduced" ~ "PO Reduced",
          sh == "NPO_0to1"   ~ "NPO 0→1",
          sh == "NPO_1to2"   ~ "NPO 1→2",
          sh == "NPO_2to3"   ~ "NPO 2→3"
        )
      )
  }) %>%
  mutate(
    slice = factor(slice,
      levels = c("PO Full","PO Reduced","NPO 0→1","NPO 1→2","NPO 2→3")),
    sig   = FDR_p < 0.05
  )

#PO-only figure
plot_PO <- plot_df %>%
  filter(slice %in% c("PO Full","PO Reduced")) %>%
  ggplot(aes(x = OR,
             y = factor(Comparison, levels = rev(unique(Comparison))),
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  scale_x_log10(breaks = c(.25,.5,1,2,4,8,16,32),
                limits = c(.2, 33)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .35), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – PO Models (Bronchiectasis)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() + theme(legend.position = "bottom",
                     axis.text.y = element_text(size = 7))

#NPO figure with facets
plot_NPO <- plot_df %>% 
  filter(str_detect(slice, "^NPO")) %>% 
  mutate(Comparison = reorder_within(Comparison,
                                     -row_number(),
                                     slice)) %>% 
  ggplot(aes(x = OR,
             y = Comparison,
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  facet_wrap(~ slice, ncol = 1, scales = "free_y") +
  scale_y_reordered() +
  scale_x_log10(breaks = c(.25, .5, 1, 2, 4, 8, 16, 32, 64, 128),
                limits = c(.2, max(plot_df$OR_high) * 1.05)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .30), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – NPO Cut-Points (Bronchiectasis)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() +
  theme(strip.text  = element_text(face = "bold"),
        axis.text.y = element_text(size = 7))


#save
ggsave(file.path(folder, "BRONCH_PO_forest.png"),  plot_PO,
       width = 7, height = 8, dpi = 300)
ggsave(file.path(folder, "BRONCH_NPO_forest.png"), plot_NPO,
       width = 7, height = 10, dpi = 300)

```

### Atelectasis

```{r}
feature_file <- file.path(folder, "atel.xlsx")

slice_rgx <- "(PO_main)"

plot_df <- excel_sheets(feature_file) %>%
  keep(~ str_detect(.x, slice_rgx)) %>%
  map_dfr(function(sh) {

    read_excel(feature_file, sheet = sh) %>%
      transmute(
        Comparison,
        OR      = Odds_Ratio,
        OR_low  = OR_LowerCI,
        OR_high = OR_UpperCI,
        FDR_p   = FDR_p,
        slice   = case_when(
          sh == "PO_main"    ~ "PO Reduced"
        )
      )
  }) %>%
  mutate(
    slice = factor(slice),
      levels = c("PO Reduced"),
    sig   = FDR_p < 0.05
  )

#PO-only figure
plot_PO <- plot_df %>%
  filter(slice %in% c("PO Reduced")) %>%
  ggplot(aes(x = OR,
             y = factor(Comparison, levels = rev(unique(Comparison))),
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  scale_x_log10(breaks = c(.25,.5,1,2,4,8, 16, 32),
                limits = c(.2, max(plot_df$OR_high)*1.05)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .35), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – PO Model (Atelectasis)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() + theme(legend.position = "bottom",
                     axis.text.y = element_text(size = 7))

#save
ggsave(file.path(folder, "ATEL_PO_forest.png"),  plot_PO,
       width = 7, height = 8, dpi = 300)

```

### Thin Wall Cavity

```{r}
feature_file <- file.path(folder, "thin.xlsx")

slice_rgx <- "(PO_main)"

plot_df <- excel_sheets(feature_file) %>%
  keep(~ str_detect(.x, slice_rgx)) %>%
  map_dfr(function(sh) {

    read_excel(feature_file, sheet = sh) %>%
      transmute(
        Comparison,
        OR      = Odds_Ratio,
        OR_low  = OR_LowerCI,
        OR_high = OR_UpperCI,
        FDR_p   = FDR_p,
        slice   = case_when(
          sh == "PO_main"    ~ "Reduced"
        )
      )
  }) %>%
  mutate(
    slice = factor(slice),
      levels = c("Reduced"),
    sig   = FDR_p < 0.05
  )

#PO-only figure
plot_PO <- plot_df %>%
  filter(slice %in% c("Reduced")) %>%
  ggplot(aes(x = OR,
             y = factor(Comparison, levels = rev(unique(Comparison))),
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  scale_x_log10(breaks = c(.25,.5,1,2,4,8, 16),
                limits = c(.2, max(plot_df$OR_high)*1.05)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .35), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – Reduced Model (Thin Wall Cavity)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() + theme(legend.position = "bottom",
                     axis.text.y = element_text(size = 7))

#save
ggsave(file.path(folder, "THIN_PO_forest.png"),  plot_PO,
       width = 7, height = 8, dpi = 300)

```

### Thick Wall Cavity

```{r}
feature_file <- file.path(folder, "thick.xlsx")

slice_rgx <- "(PO_main)"

plot_df <- excel_sheets(feature_file) %>%
  keep(~ str_detect(.x, slice_rgx)) %>%
  map_dfr(function(sh) {

    read_excel(feature_file, sheet = sh) %>%
      transmute(
        Comparison,
        OR      = Odds_Ratio,
        OR_low  = OR_LowerCI,
        OR_high = OR_UpperCI,
        FDR_p   = FDR_p,
        slice   = case_when(
          sh == "PO_main"    ~ "Reduced"
        )
      )
  }) %>%
  mutate(
    slice = factor(slice),
      levels = c("Reduced"),
    sig   = FDR_p < 0.05
  )

#PO-only figure
plot_PO <- plot_df %>%
  filter(slice %in% c("Reduced")) %>%
  ggplot(aes(x = OR,
             y = factor(Comparison, levels = rev(unique(Comparison))),
             colour = slice,
             shape  = slice,
             alpha  = sig)) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  geom_errorbarh(aes(xmin = OR_low, xmax = OR_high),
                 height = .25,
                 position = position_dodge(width = .7)) +
  geom_point(size = 3, position = position_dodge(width = .7)) +
  scale_x_log10(breaks = c(.25,.5,1,2,4,8, 16, 32, 64, 128),
                limits = c(.2, max(plot_df$OR_high)*1.05)) +
  scale_alpha_manual(values = c(`TRUE` = 1, `FALSE` = .35), guide = "none") +
  labs(title = "Lobe-to-lobe Odds Ratios – Reduced Model (Thick Wall Cavity)",
       x = "Odds Ratio", y = NULL,
       colour = NULL, shape = NULL) +
  theme_bw() + theme(legend.position = "bottom",
                     axis.text.y = element_text(size = 7))

#save
ggsave(file.path(folder, "THICK_PO_forest.png"),  plot_PO,
       width = 7, height = 8, dpi = 300)

```

## Heatmaps

### Atelectasis

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/atel.xlsx'
df <- read_excel(file_path)

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Atelectasis",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

### Bronchiectasis

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/bronch.xlsx'
df <- read_excel(file_path, sheet='PO_main')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Bronchiectasis (Full)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/bronch.xlsx'
df <- read_excel(file_path, sheet='PO_reduced')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Bronchiectasis (Reduced)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/bronch.xlsx'
df <- read_excel(file_path, sheet='NPO_0to1')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Bronchiectasis (NPO 0|1)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/bronch.xlsx'
df <- read_excel(file_path, sheet='NPO_1to2')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Bronchiectasis (NPO 1|2)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/bronch.xlsx'
df <- read_excel(file_path, sheet='NPO_2to3')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Bronchiectasis (NPO 2|3)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

### Consolidation

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/cons.xlsx'
df <- read_excel(file_path, sheet='PO_main')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Consolidation (Full)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/cons.xlsx'
df <- read_excel(file_path, sheet='PO_reduced')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Consolidation (Reduced)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

### Ground-glass Opacities

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/ggo.xlsx'
df <- read_excel(file_path, sheet='PO_main')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - GGO (Full)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/ggo.xlsx'
df <- read_excel(file_path, sheet='PO_reduced')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - GGO (Reduced)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

### Large Nodules

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/ln.xlsx'
df <- read_excel(file_path)

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Large Nodules",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

### Thick Wall Cavity

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/thick.xlsx'
df <- read_excel(file_path)

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Thick Wall Cavities",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

### Thin Wall Cavity

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/thin.xlsx'
df <- read_excel(file_path)

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Thin Wall Cavities",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

### Tree-in-bud

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/tib.xlsx'
df <- read_excel(file_path, sheet='PO_main')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Tree-in-bud (Full)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/tib.xlsx'
df <- read_excel(file_path, sheet='PO_reduced')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Tree-in-bud (Reduced)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/tib.xlsx'
df <- read_excel(file_path, sheet='NPO_0to1')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Tree-in-bud (NPO 0|1)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/tib.xlsx'
df <- read_excel(file_path, sheet='NPO_1to2')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Tree-in-bud (NPO 1|2)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```

```{r}
#read data
file_path <- 'C:/Users/Eddie/OneDrive/Desktop/BIOSTAT/Thesis/Thesis/Reports/Lobewise Comparisons/ResultsFinal/tib.xlsx'
df <- read_excel(file_path, sheet='NPO_2to3')

#split comparison column into two lobes
df <- df %>%
  mutate(
    Lobe1 = str_trim(str_extract(Comparison, "^[^v]+")),
    Lobe2 = str_trim(str_extract(Comparison, "(?<=vs ).*"))
  )

#add reciprocal rows
recip_df <- df %>%
  mutate(
    temp = Lobe1,
    Lobe1 = Lobe2,
    Lobe2 = temp,
    Odds_Ratio = 1 / Odds_Ratio
  ) %>%
  select(Comparison, Odds_Ratio, Lobe1, Lobe2)

#add diagonal
lobes <- sort(unique(c(df$Lobe1, df$Lobe2)))
diag_df <- tibble(
  Lobe1 = lobes,
  Lobe2 = lobes,
  Odds_Ratio = 1,
  Comparison = paste0(Lobe1, " vs ", Lobe2)
)

#combine original, reciprocal, and diagonal data
df_full <- bind_rows(
  df %>% select(Comparison, Odds_Ratio, Lobe1, Lobe2),
  recip_df,
  diag_df
)

#plot heatmap
ggplot(df_full, aes(x = Lobe1, y = Lobe2, fill = Odds_Ratio)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "white", high = "red", na.value = "grey90") +
  coord_fixed() +
  theme_minimal(base_size = 14) +
  labs(
    title = "Lobe-wise Odds Ratios - Tree-in-bud (NPO 2|3)",
    x = "Reference Lobe",
    y = "Compared Lobe",
    fill = "Odds Ratio"
  )

```